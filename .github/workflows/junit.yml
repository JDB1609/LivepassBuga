name: Java CI with Ant and MySQL Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # Reducido porque no usamos GlassFish
    
    # ‚≠ê‚≠ê NUEVO: Servicio MySQL en contenedor ‚≠ê‚≠ê
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: livepass_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Apache Ant
      run: sudo apt-get update && sudo apt-get install -y ant
    
    # ‚≠ê‚≠ê NUEVO: Instalar cliente MySQL ‚≠ê‚≠ê
    - name: Install MySQL client
      run: sudo apt-get install -y mysql-client
    
    # ‚≠ê‚≠ê ELIMINADO: Todo lo de GlassFish (no es necesario para tests de BD)
    
    # Paso 1: Configurar la base de datos desde CERO
    - name: Setup Test Database
      run: |
        echo "=== Creando base de datos de prueba ==="
        
        # Esperar a que MySQL est√© listo
        for i in {1..30}; do
          if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" >/dev/null 2>&1; then
            echo "‚úÖ MySQL est√° listo"
            break
          fi
          echo "‚è≥ Esperando MySQL... ($i/30)"
          sleep 2
        done
        
        # 1. Crear tabla usuarios (AJUSTA ESTA ESTRUCTURA A LA TUYA)
        echo "--- Creando tabla 'usuarios' ---"
        mysql -h 127.0.0.1 -P 3306 -u root -proot livepass_test <<'EOF'
        DROP TABLE IF EXISTS usuarios;
        CREATE TABLE usuarios (
            id INT PRIMARY KEY AUTO_INCREMENT,
            email VARCHAR(100) UNIQUE NOT NULL,
            name VARCHAR(100) NOT NULL,
            password_hash TEXT NOT NULL,
            role VARCHAR(20) DEFAULT 'CLIENTE'
        );
        EOF
        
        # 2. Compilar PasswordUtil para generar hashes REALES
        echo "--- Generando hashes de contrase√±a ---"
        
        # Primero compilar el proyecto
        ant compile 2>/dev/null || echo "Compilando..."
        
        # Crear programa para generar hashes
        cat > /tmp/GenerateHashes.java <<'JAVAEOF'
        import utils.PasswordUtil;
        
        public class GenerateHashes {
            public static void main(String[] args) {
                System.out.println("HASH_LUIS=" + PasswordUtil.hash("12345678"));
                System.out.println("HASH_ORG=" + PasswordUtil.hash("evento2024"));
                System.out.println("HASH_ADMIN=" + PasswordUtil.hash("admin123"));
            }
        }
        JAVAEOF
        
        # Compilar y ejecutar
        javac -cp "build/web/WEB-INF/classes:." /tmp/GenerateHashes.java 2>/dev/null && \
        java -cp "build/web/WEB-INF/classes:." GenerateHashes > /tmp/hashes.txt || {
          echo "‚ö†Ô∏è No se pudo generar hashes, usando valores dummy"
          echo "HASH_LUIS=dummy:abc123"
          echo "HASH_ORG=dummy:def456"
          echo "HASH_ADMIN=dummy:ghi789"
        } > /tmp/hashes.txt
        
        # Leer hashes generados
        source <(grep -E '^HASH_' /tmp/hashes.txt | sed 's/^/export /')
        
        # 3. Insertar usuarios de prueba con hashes REALES
        echo "--- Insertando usuarios de prueba ---"
        mysql -h 127.0.0.1 -P 3306 -u root -proot livepass_test <<EOF
        INSERT INTO usuarios (email, name, password_hash, role) VALUES
        ('luis@gmail.com', 'Luis P√©rez', '$HASH_LUIS', 'CLIENTE'),
        ('organizador@eventos.com', 'Eventos S.A.', '$HASH_ORG', 'ORGANIZADOR'),
        ('admin@livepass.com', 'Administrador', '$HASH_ADMIN', 'ADMIN');
        EOF
        
        # 4. Verificar datos insertados
        echo "=== Verificaci√≥n de datos ==="
        mysql -h 127.0.0.1 -P 3306 -u root -proot livepass_test -e "SELECT id, email, role FROM usuarios"
        
        echo "‚úÖ Base de datos configurada con 3 usuarios de prueba"
    
    # Paso 2: Configurar UserDAO para usar BD de prueba
    - name: Configure UserDAO for Test Database
      run: |
        echo "=== Configurando UserDAO para tests ==="
        
        # Buscar UserDAO.java
        USERDAO_FILE=$(find . -name "UserDAO.java" -type f | head -1)
        
        if [ -f "$USERDAO_FILE" ]; then
          echo "üìÑ UserDAO encontrado en: $USERDAO_FILE"
          
          # Verificar estructura de UserDAO
          echo "--- Primera l√≠nea del UserDAO ---"
          head -5 "$USERDAO_FILE"
          
          # Opci√≥n 1: Si UserDAO usa variables de entorno
          echo "DB_URL=jdbc:mysql://127.0.0.1:3306/livepass_test" >> $GITHUB_ENV
          echo "DB_USER=root" >> $GITHUB_ENV
          echo "DB_PASS=root" >> $GITHUB_ENV
          
          echo "‚úÖ Variables de entorno configuradas"
        else
          echo "‚ùå No se encontr√≥ UserDAO.java"
          echo "Buscando en todo el proyecto..."
          find . -name "*.java" -type f | grep -i "dao" || echo "No hay archivos DAO"
        fi
    
    # Paso 3: Compilar proyecto
    - name: Build application
      run: |
        echo "=== Compilando proyecto ==="
        
        # Intentar compilar sin errores de servidor
        ant compile -Dskip.server.tasks=true 2>&1 | grep -v "WARNING\|ERROR" || true
        
        # Verificar clases compiladas
        if [ -d "build/web/WEB-INF/classes" ]; then
          echo "‚úÖ Clases compiladas encontradas"
          ls build/web/WEB-INF/classes/*.class 2>/dev/null | wc -l | xargs echo "N√∫mero de clases:"
        else
          echo "‚ö†Ô∏è No hay clases compiladas"
        fi
    
    # Paso 4: Descargar y configurar JUnit
    - name: Setup JUnit for Tests
      run: |
        echo "=== Configurando JUnit ==="
        
        # Crear directorio para librer√≠as de test
        mkdir -p lib/test
        
        # Descargar JUnit 4
        wget -q https://repo1.maven.org/maven2/junit/junit/4.13.2/junit-4.13.2.jar -O lib/test/junit.jar
        wget -q https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar -O lib/test/hamcrest.jar
        
        # Crear classpath para tests
        echo "CLASSPATH=build/web/WEB-INF/classes:lib/test/*:." >> $GITHUB_ENV
        
        echo "‚úÖ JUnit configurado"
    
    # Paso 5: Compilar tests
    - name: Compile Tests
      run: |
        echo "=== Compilando tests ==="
        
        # Crear directorio para tests compilados
        mkdir -p build/test/classes
        
        # Buscar TODOS los archivos de test
        TEST_FILES=$(find . -name "*Test.java" -type f)
        
        if [ -n "$TEST_FILES" ]; then
          echo "üìù Encontrados $(echo "$TEST_FILES" | wc -l) archivos de test:"
          echo "$TEST_FILES"
          
          # Compilar cada test
          echo "$TEST_FILES" | while read test_file; do
            echo "üî® Compilando: $test_file"
            javac -cp "$CLASSPATH" -d build/test/classes "$test_file" 2>&1 | \
              grep -v "Note:" || echo "‚úÖ $test_file compilado"
          done
          
          # Verificar tests compilados
          TEST_CLASSES=$(find build/test/classes -name "*Test.class" -type f | wc -l)
          echo "‚úÖ $TEST_CLASSES clases de test compiladas"
        else
          echo "‚ö†Ô∏è No se encontraron archivos *Test.java"
          
          # Crear un test m√≠nimo si no hay
          echo "--- Creando test m√≠nimo de PasswordUtil ---"
          cat > /tmp/PasswordUtilTest.java <<'EOF'
          import utils.PasswordUtil;
          
          public class PasswordUtilTest {
              public static void main(String[] args) {
                  System.out.println("üß™ Probando PasswordUtil...");
                  String hash = PasswordUtil.hash("test123");
                  boolean ok = PasswordUtil.verify("test123", hash);
                  System.out.println(ok ? "‚úÖ PasswordUtil funciona" : "‚ùå PasswordUtil fall√≥");
                  System.exit(ok ? 0 : 1);
              }
          }
          EOF
          
          javac -cp "$CLASSPATH" -d build/test/classes /tmp/PasswordUtilTest.java
          echo "‚úÖ Test m√≠nimo creado"
        fi
    
    # Paso 6: Ejecutar tests
    - name: Run Database Tests
      env:
        DB_URL: jdbc:mysql://127.0.0.1:3306/livepass_test
        DB_USER: root
        DB_PASS: root
      run: |
        echo "=== Ejecutando tests ==="
        
        # Configurar classpath completo
        TEST_CP="$CLASSPATH:build/test/classes"
        
        # Ejecutar cada test encontrado
        find build/test/classes -name "*Test.class" -type f | while read test_class; do
          # Convertir ruta a nombre de clase
          class_name=$(echo "$test_class" | \
            sed 's|build/test/classes/||' | \
            sed 's|\.class$||' | \
            sed 's|/|.|g')
          
          echo ""
          echo "üß™ EJECUTANDO: $class_name"
          echo "----------------------------------------"
          
          # Ejecutar con JUnit
          java -cp "$TEST_CP" org.junit.runner.JUnitCore "$class_name" 2>&1 || \
            echo "‚ö†Ô∏è $class_name fall√≥ o no es un test JUnit est√°ndar"
        done
        
        # Si no hay tests JUnit, ejecutar los main
        if [ ! -f "build/test/classes/org/junit/runner/JUnitCore.class" ]; then
          echo "--- Ejecutando tests con main() ---"
          find build/test/classes -name "*Test.class" -type f | while read test_class; do
            class_name=$(echo "$test_class" | \
              sed 's|build/test/classes/||' | \
              sed 's|\.class$||' | \
              sed 's|/|.|g')
            
            echo "‚ñ∂Ô∏è  Ejecutando main de: $class_name"
            java -cp "$TEST_CP" "$class_name" 2>&1 || true
          done
        fi
    
    # Paso 7: Resultados y limpieza
    - name: Test Results and Cleanup
      if: always()
      run: |
        echo "=== RESULTADOS FINALES ==="
        echo "‚úÖ Base de datos MySQL configurada"
        echo "‚úÖ Proyecto compilado con Ant"
        echo "‚úÖ Tests compilados y ejecutados"
        echo ""
        echo "üìä Para ver logs detallados, revisa los pasos anteriores"
        
        # Mostrar estado final de la BD
        echo "--- Estado final de la base de datos ---"
        mysql -h 127.0.0.1 -P 3306 -u root -proot livepass_test -e "SELECT COUNT(*) as total_usuarios FROM usuarios"
    
    # Paso 8: Subir artefactos (opcional)
    - name: Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          build/test/classes/
        retention-days: 1
