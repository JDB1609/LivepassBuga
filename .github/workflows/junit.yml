name: Java CI with Ant

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Tests pueden tardar
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Apache Ant
      run: sudo apt-get update && sudo apt-get install -y ant
    
    # SOLUCIÓN CRÍTICA: Obtener el JAR real de CopyLibs
    - name: Fix CopyLibs dependency
      run: |
        mkdir -p libs
        # Descargar el JAR REAL de una fuente confiable
        wget -O libs/copylibstask.jar https://search.maven.org/remotecontent?filepath=org/netbeans/modules/org-netbeans-modules-java-j2seproject/RELEASE210/org-netbeans-modules-java-j2seproject-RELEASE210-copylibstask.jar
        # Alternativa: Si tienes NetBeans instalado localmente, súbelo a tu repo
        # echo "Si falla, sube manualmente el JAR desde tu NetBeans a libs/"
    
    - name: Install and configure GlassFish
      run: |
        # 1. Instalar GlassFish
        wget -q https://github.com/eclipse-ee4j/glassfish/releases/download/6.2.5/glassfish-6.2.5.zip
        unzip -q glassfish-6.2.5.zip -d /opt
        export GLASSFISH_HOME=/opt/glassfish6
        
        # 2. Configurar propiedades ANT
        mkdir -p nbproject/private
        cat > nbproject/private/private.properties << EOF
        j2ee.server.home=/opt/glassfish6
        j2ee.server.type=GlassFish
        libs.CopyLibs.classpath=libs/copylibstask.jar
        EOF
        
        # 3. Dar permisos de ejecución
        chmod +x /opt/glassfish6/bin/asadmin
        
        echo "GLASSFISH_HOME=/opt/glassfish6" >> $GITHUB_ENV
    
    # PASO NUEVO: Compilar y desplegar la aplicación
    - name: Build and deploy to GlassFish
      run: |
        # Compilar el proyecto
        ant compile -Dj2ee.server.home=/opt/glassfish6 -Dlibs.CopyLibs.classpath=libs/copylibstask.jar
        
        # Crear el WAR
        ant dist -Dj2ee.server.home=/opt/glassfish6 -Dlibs.CopyLibs.classpath=libs/copylibstask.jar
        
        # Iniciar GlassFish
        /opt/glassfish6/bin/asadmin start-domain domain1
        
        # Desplegar la aplicación
        /opt/glassfish6/bin/asadmin deploy --force=true dist/LivepassPagina.war
        
        # Esperar a que esté listo
        sleep 15
        echo "✅ Aplicación desplegada en http://localhost:8080/LivepassPagina/"
    
    # PASO NUEVO: Ejecutar tests CON el servidor corriendo
    - name: Run HTTP integration tests
      run: |
        echo "=== Ejecutando tests de integración HTTP ==="
        
        # Compilar los tests (si están separados)
        # ant compile-test -Dj2ee.server.home=/opt/glassfish6 -Dlibs.CopyLibs.classpath=libs/copylibstask.jar
        
        # Ejecutar tests JUnit directamente (no usar 'ant test')
        # Buscar todas las clases de test
        find . -name "*Test.java" | while read test; do
          echo "Encontrado test: $test"
        done
        
        # Ejecutar la clase LoginTest específicamente
        javac -cp "build/web/WEB-INF/classes:lib/*:build/test/classes:." LoginTest/LoginTest.java
        
        java -cp "build/web/WEB-INF/classes:lib/*:build/test/classes:." \
             org.junit.runner.JUnitCore LoginTest.LoginTest
        
      continue-on-error: false
    
    - name: Stop GlassFish and collect logs
      if: always()
      run: |
        /opt/glassfish6/bin/asadmin stop-domain domain1 || true
        # Guardar logs del servidor
        cp /opt/glassfish6/glassfish/domains/domain1/logs/server.log ./glassfish-server.log 2>/dev/null || echo "No logs found"
    
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          glassfish-server.log
          build/test/results/
          dist/
