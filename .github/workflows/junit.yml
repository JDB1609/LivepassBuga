name: Java CI with Ant

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Apache Ant
      run: sudo apt-get update && sudo apt-get install -y ant
    
    - name: Install and configure GlassFish
      run: |
        # Descargar e instalar GlassFish
        wget -q https://github.com/eclipse-ee4j/glassfish/releases/download/6.2.5/glassfish-6.2.5.zip
        unzip -q glassfish-6.2.5.zip -d /opt
        export GLASSFISH_HOME=/opt/glassfish6
        
        # Configurar propiedades ANT (sin CopyLibs)
        mkdir -p nbproject/private
        cat > nbproject/private/private.properties << EOF
        j2ee.server.home=/opt/glassfish6
        j2ee.server.type=GlassFish
        EOF
        
        # Dar permisos de ejecuci√≥n
        chmod +x /opt/glassfish6/bin/asadmin
        
        echo "GLASSFISH_HOME=/opt/glassfish6" >> $GITHUB_ENV
    
    - name: Build application (compile only)
      run: |
        echo "=== Compilando aplicaci√≥n ==="
        ant compile -Dj2ee.server.home=/opt/glassfish6 || true
        
        # Verificar que se compil√≥
        if [ -d "build/web/WEB-INF/classes" ]; then
          echo "‚úÖ Compilaci√≥n exitosa"
          ls -la build/web/WEB-INF/classes
        else
          echo "‚ö†Ô∏è No se encontraron clases compiladas"
        fi
    
    - name: Create WAR manually (without CopyLibs)
      run: |
        echo "=== Creando WAR manualmente ==="
        mkdir -p dist
        
        # Crear estructura WAR
        cd build/web
        jar -cvf ../../dist/LivepassPagina.war *
        cd ../..
        
        echo "‚úÖ WAR creado: dist/LivepassPagina.war"
        ls -lh dist/LivepassPagina.war
    
    - name: Start GlassFish and deploy
      run: |
        echo "=== Iniciando GlassFish ==="
        /opt/glassfish6/bin/asadmin start-domain domain1
        
        # Esperar a que inicie
        sleep 10
        
        # Verificar que est√° corriendo
        /opt/glassfish6/bin/asadmin list-domains
        
        echo "=== Desplegando aplicaci√≥n ==="
        /opt/glassfish6/bin/asadmin deploy --force=true dist/LivepassPagina.war
        
        # Listar aplicaciones desplegadas
        /opt/glassfish6/bin/asadmin list-applications
        
        # Esperar a que est√© lista
        sleep 15
        
        echo "‚úÖ Aplicaci√≥n desplegada en http://localhost:8080/LivepassPagina/"
    
    - name: Test application endpoint
      run: |
        echo "=== Probando endpoint de la aplicaci√≥n ==="
        
        # Test b√°sico con curl
        curl -I http://localhost:8080/LivepassPagina/ || echo "‚ö†Ô∏è Endpoint no responde"
        
        # Probar p√°gina de login si existe
        curl -I http://localhost:8080/LivepassPagina/login || echo "‚ö†Ô∏è Login page no encontrada"
    
    - name: Compile and run tests
      run: |
        echo "=== Compilando tests ==="
        
        # Crear directorio de tests compilados
        mkdir -p build/test/classes
        
        # BUSCAR ARCHIVOS DE TEST EN TODO EL PROYECTO
        echo "=== Buscando archivos de test en el repositorio ==="
        find . -name "*Test.java" -type f
        
        # Listar estructura completa del proyecto
        echo "=== Estructura del proyecto ==="
        ls -la
        
        # Buscar en ubicaciones comunes
        for dir in test src/test LoginTest tests Test; do
          if [ -d "$dir" ]; then
            echo "‚úÖ Encontrado directorio: $dir"
            find "$dir" -name "*.java" -type f
          fi
        done
        
        # Descargar JUnit SIEMPRE
        mkdir -p lib/test
        echo "=== Descargando JUnit ==="
        wget -q https://repo1.maven.org/maven2/junit/junit/4.13.2/junit-4.13.2.jar -O lib/test/junit-4.13.2.jar
        wget -q https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar -O lib/test/hamcrest-core-1.3.jar
        echo "‚úÖ JUnit descargado"
        
        # BUSCAR Y COMPILAR CUALQUIER ARCHIVO *Test.java
        echo "=== Compilando todos los tests encontrados ==="
        find . -name "*Test.java" -type f | while read test_file; do
          echo "üìù Compilando: $test_file"
          javac -cp "build/web/WEB-INF/classes:lib/test/*:." \
                -d build/test/classes \
                "$test_file" 2>&1 || echo "‚ö†Ô∏è Error compilando $test_file"
        done
        
        # EJECUTAR TESTS COMPILADOS
        echo "=== Ejecutando tests ==="
        if [ -d "build/test/classes" ]; then
          # Buscar todas las clases compiladas que terminen en Test
          find build/test/classes -name "*Test.class" | while read test_class; do
            # Convertir ruta a nombre de clase (ej: build/test/classes/LoginTest/LoginTest.class -> LoginTest.LoginTest)
            class_name=$(echo "$test_class" | sed 's|build/test/classes/||' | sed 's|\.class$||' | sed 's|/|.|g')
            echo "üß™ Ejecutando: $class_name"
            
            java -cp "build/web/WEB-INF/classes:lib/test/*:build/test/classes" \
                 org.junit.runner.JUnitCore "$class_name" || echo "‚ùå Test $class_name fall√≥"
          done
        else
          echo "‚ùå No se compilaron tests"
        fi
      continue-on-error: true
    
    - name: Stop GlassFish and collect logs
      if: always()
      run: |
        echo "=== Deteniendo GlassFish ==="
        /opt/glassfish6/bin/asadmin stop-domain domain1 || true
        
        # Guardar logs del servidor
        if [ -f "/opt/glassfish6/glassfish/domains/domain1/logs/server.log" ]; then
          cp /opt/glassfish6/glassfish/domains/domain1/logs/server.log ./glassfish-server.log
          echo "‚úÖ Logs guardados"
        else
          echo "‚ö†Ô∏è No se encontraron logs"
        fi
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          glassfish-server.log
          dist/LivepassPagina.war
          build/test/classes/
